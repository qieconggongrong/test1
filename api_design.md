# API设计文档

## 概述

本文档详细描述"AI驱动的动态叙事像素RPG"项目的API设计，遵循RESTful风格，实现前后端分离架构。

## API端点

### 用户相关

| 方法 | 端点 | 描述 | 请求体 | 响应 |
|------|------|------|--------|------|
| POST | /api/auth/register/ | 用户注册 | `{用户名, 密码, 邮箱}` | `{状态, 数据:{用户信息}, 消息, 代码}` |
| POST | /api/auth/login/ | 用户登录 | `{用户名, 密码}` | `{状态, 数据:{token, 用户信息}, 消息, 代码}` |
| POST | /api/auth/logout/ | 用户注销 | `{}` | `{状态, 消息, 代码}` |
| GET | /api/auth/user/ | 获取当前用户信息 | - | `{状态, 数据:{用户信息}, 消息, 代码}` |

### 游戏数据

| 方法 | 端点 | 描述 | 请求体 | 响应 |
|------|------|------|--------|------|
| GET | /api/game/save/ | 获取存档列表 | - | `{状态, 数据:[{存档信息}], 消息, 代码}` |
| POST | /api/game/save/ | 创建新存档 | `{存档名称, 角色数据}` | `{状态, 数据:{存档ID}, 消息, 代码}` |
| GET | /api/game/save/{id}/ | 获取特定存档 | - | `{状态, 数据:{存档详情}, 消息, 代码}` |
| PUT | /api/game/save/{id}/ | 更新存档 | `{角色数据, 游戏状态}` | `{状态, 数据:{更新时间}, 消息, 代码}` |
| DELETE | /api/game/save/{id}/ | 删除存档 | - | `{状态, 消息, 代码}` |

### 游戏内容

| 方法 | 端点 | 描述 | 请求体 | 响应 |
|------|------|------|--------|------|
| GET | /api/game/map/{id}/ | 获取地图数据 | - | `{状态, 数据:{地图数据}, 消息, 代码}` |
| GET | /api/game/npc/{id}/ | 获取NPC数据 | - | `{状态, 数据:{NPC数据}, 消息, 代码}` |
| POST | /api/game/npc/{id}/dialogue/ | 获取NPC对话 | `{玩家输入, 对话历史}` | `{状态, 数据:{对话内容}, 消息, 代码}` |
| GET | /api/game/item/{id}/ | 获取物品数据 | - | `{状态, 数据:{物品数据}, 消息, 代码}` |
| GET | /api/game/quest/ | 获取任务列表 | - | `{状态, 数据:[{任务信息}], 消息, 代码}` |
| GET | /api/game/quest/{id}/ | 获取任务详情 | - | `{状态, 数据:{任务详情}, 消息, 代码}` |
| PUT | /api/game/quest/{id}/ | 更新任务状态 | `{任务状态, 进度}` | `{状态, 数据:{更新结果}, 消息, 代码}` |

### AI内容生成

| 方法 | 端点 | 描述 | 请求体 | 响应 |
|------|------|------|--------|------|
| POST | /api/ai/generate/quest/ | 生成任务 | `{上下文, 难度, 类型}` | `{状态, 数据:{任务内容}, 消息, 代码}` |
| POST | /api/ai/generate/dialogue/ | 生成对话 | `{NPC信息, 对话历史, 当前情境}` | `{状态, 数据:{对话内容}, 消息, 代码}` |
| POST | /api/ai/generate/description/ | 生成描述 | `{物品/地点信息, 描述类型}` | `{状态, 数据:{描述文本}, 消息, 代码}` |

## 响应格式

所有API响应均使用统一的JSON格式：

```json
{
  "状态": "成功",  // 或 "错误"
  "数据": {
    // 响应数据，根据端点不同而变化
  },
  "消息": "操作成功",  // 或错误信息
  "代码": 200  // HTTP状态码
}
```

## 认证机制

* 使用JWT (JSON Web Token) 进行身份验证
* 除注册和登录外，所有API请求需在请求头中包含有效的认证令牌
* 令牌格式：`Authorization: Bearer <token>`

## 错误处理

| 状态码 | 描述 |
|--------|------|
| 200 | 请求成功 |
| 201 | 资源创建成功 |
| 400 | 请求参数错误 |
| 401 | 未授权访问 |
| 403 | 禁止访问 |
| 404 | 资源不存在 |
| 500 | 服务器内部错误 |

## 数据模型

### 用户模型
- ID: 唯一标识符
- 用户名: 字符串
- 密码: 加密存储
- 邮箱: 字符串
- 创建时间: 日期时间

### 存档模型
- ID: 唯一标识符
- 用户ID: 外键关联用户
- 存档名称: 字符串
- 创建时间: 日期时间
- 更新时间: 日期时间
- 角色数据: JSON (包含角色属性、位置、背包等)
- 游戏状态: JSON (包含任务进度、对话历史等)

### 地图模型
- ID: 唯一标识符
- 名称: 字符串
- 瓦片数据: JSON
- 碰撞区域: JSON
- NPC分布: JSON
- 物品分布: JSON
- 传送点: JSON

### NPC模型
- ID: 唯一标识符
- 名称: 字符串
- 角色设定: 文本
- 初始位置: JSON
- 对话ID列表: JSON

### 物品模型
- ID: 唯一标识符
- 名称: 字符串
- 类型: 字符串 (任务道具/消耗品/装备)
- 描述: 文本
- 效果: JSON
- 图标: 字符串 (资源路径)

### 任务模型
- ID: 唯一标识符
- 名称: 字符串
- 描述: 文本
- 目标: JSON
- 完成条件: JSON
- 奖励: JSON
- 前置任务ID: 整数
- 触发条件: JSON

### AI生成内容模型
- ID: 唯一标识符
- 类型: 字符串 (任务/对话/描述)
- 原始Prompt: 文本
- 生成文本: 文本
- 生成时间: 日期时间
- 相关上下文: JSON

## 安全考虑

1. 所有API请求使用HTTPS加密传输
2. 实施请求频率限制，防止滥用
3. 输入验证和消毒，防止注入攻击
4. 敏感数据加密存储
5. CORS策略限制跨域请求
6. 日志记录异常请求和错误

## 版本控制

API版本通过URL路径前缀指定，如`/api/v1/`。当前文档描述v1版本API。
